generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CashMovementType {
  INCOME
  EXPENSE
}

enum CashMovementStatus {
  PENDING
  APPROVED
  REJECTED
  DELIVERED
}

model Organization {
  id   String @id @default(uuid())
  name String
  slug String @unique

  users         User[]
  branches      Branch[]
  cashMovements CashMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model Branch {
  id String @id @default(uuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name      String
  code      String?
  cashLimit Decimal? @db.Decimal(14, 2)

  users         User[]
  cashMovements CashMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@unique([organizationId, name])
}

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String
  isActive Boolean @default(true)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  branchId       String?
  branch         Branch?      @relation(fields: [branchId], references: [id], onDelete: SetNull)

  roles     UserRole[]
  sessions  AuthSession[]
  auditLogs AuditLog[]

  passwordResetTokens PasswordResetToken[]
  createdCashMovements CashMovement[] @relation("CashMovementCreatedBy")
  approvedCashMovements CashMovement[] @relation("CashMovementApprovedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([branchId])
}

model AuthSession {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  hashedRefreshToken String
  expiresAt          DateTime

  ip        String?
  userAgent String?

  revokedAt    DateTime?
  replacedById String?
  replacedBy   AuthSession?  @relation("SessionRotation", fields: [replacedById], references: [id])
  replacements AuthSession[] @relation("SessionRotation")

  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  users       UserRole[]
  permissions RolePermission[]
  createdAt   DateTime         @default(now())
}

model Permission {
  id          String           @id @default(uuid())
  key         String           @unique
  description String?
  roles       RolePermission[]
  createdAt   DateTime         @default(now())
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model AuditLog {
  id          String  @id @default(uuid())
  actorUserId String?
  actorUser   User?   @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  action     String // "users.create", "auth.login", etc
  entity     String? // "User", "Operation"
  entityId   String? // uuid
  method     String
  path       String
  ip         String?
  userAgent  String?
  statusCode Int?
  requestId  String?

  metadata  Json? // extra data
  createdAt DateTime @default(now())

  @@index([actorUserId])
  @@index([action])
  @@index([entity, entityId])
  @@index([createdAt])
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model CashMovement {
  id String @id @default(uuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Restrict)

  type   CashMovementType
  amount Decimal          @db.Decimal(14, 2)

  description String?
  status      CashMovementStatus @default(PENDING)

  createdById String
  createdBy   User @relation("CashMovementCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  approvedById String?
  approvedBy   User?    @relation("CashMovementApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedAt   DateTime?

  createdAt DateTime @default(now())

  @@index([organizationId, branchId, status, createdAt])
  @@index([branchId, status])
  @@index([createdById])
}
